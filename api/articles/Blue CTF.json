{"title":"Blue CTF - TryHackMe.com","uid":"f0b7d768b5cba845448b4aeeb8a9d261","slug":"Blue CTF","date":"2022-03-17T17:29:47.327Z","updated":"2022-03-21T14:03:19.834Z","comments":true,"path":"api/articles/Blue CTF.json","keywords":null,"cover":"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/Eye-image.jpg","content":"<p>Blue CTF专注于通过利用SMB漏洞、使用Meterpreter提升权限、破解NTLM哈希以及遍历目录找到3个Flag。</p>\n<h1 id=\"侦察\"><a href=\"#侦察\" class=\"headerlink\" title=\"侦察\"></a>侦察</h1><p>开启TryHackMe上的靶机，使用<code>ping</code>命令检查主机是否启动并开始运行。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/ping.png\" alt=\"ping\"></p>\n<p>确认靶机已经启动后，使用Nmap执行TCP SYN(<code>sS</code>)端口扫描，并对端口服务进行漏洞扫描(<code>--script=vuln</code>)，同时将其输出到blueNmapOutPut(<code>-OA</code>)。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo nmap 10.10.120.227 -sS --script&#x3D;vuln -oA blueNmapOotPut<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/nmap-sS-vuln.png\" alt=\"nmap-sS-vuln\"></p>\n<p>漏洞扫描的输出表明当前靶机存在MS17-010SMB漏洞。MS17-010允许攻击者在Windows系统上执行远程代码，靶机使用了SMBv1,并且没有更新<a href=\"https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010\">Window安全更新(4013389)</a>,导致该漏洞依旧存在。</p>\n<h1 id=\"获得访问权\"><a href=\"#获得访问权\" class=\"headerlink\" title=\"获得访问权\"></a>获得访问权</h1><p>得知靶机可以存在MS2017-010漏洞后，使用Metasploite搜索MS17-010 exploit。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_search_ms17-010.png\" alt=\"msfconsole 查找MS17-010\"></p>\n<p>在msfconsole的搜索结果中，我们选择使用广泛流传的<code>ms_17_010_eternalblue</code>(永恒之蓝)漏洞进行攻击。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_use_eternalblue.png\" alt=\"msfconsole 使用eternalblue\"></p>\n<p>查看<code>options</code>,修改必要的参数：<code>RHOSTS、LHOST</code>，然后设置Playload。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_option_set.png\" alt=\"msfconsole 设置option\"></p>\n<p>执行<code>run</code>or<code>exploit</code>。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_exploit.png\" alt=\"msfconsole exploit\"></p>\n<p>EternalBlue漏洞利用成功，我们已经拿到了靶机的的shell权限。</p>\n<h1 id=\"权限升级\"><a href=\"#权限升级\" class=\"headerlink\" title=\"权限升级\"></a>权限升级</h1><p>为了对靶机进行权限升级，我们需要将shell会话升级为Meterpreter会话。Meterpreter允许攻击者像shell一样与靶机交互，并为攻击提供了利用DLL注入机器内存直接执行Metasploit Playload的功能。</p>\n<p>DLL注入是恶意软件使用的一种代码注入形式，通过强制合法进程将恶意DLL加载到进程内存中来执行恶意代码。DLL注入的工作原理是在合法进程中分配内存，并将恶意DLL的路径复制到合法进程地址空间分配的内存中。然后使用指向Windows的<code>LoadLibrary()</code>函数的指针执行一个新线程，并使用DLL的路径名指向分配的内存，从而允许执行恶意代码。</p>\n<p>为了将shell升级到Meterpreter会话，我使用了Metasploit的<code>shell_to_meterpreter</code>模块。执行<code>Ctrl + z</code>让刚获得的shell会话转入后台运行。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/shell_cz.png\" alt=\"shell会话转入后台\"></p>\n<p>使用Metasploit搜索<code>shell_to_meterpreter</code>。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_meter_use.png\" alt=\"msfconsole 查找并使用shell_to_meterpreter\"></p>\n<p>查看<code>options</code>,修改必要的参数：<code>SESSION</code>(此处设置为我们隐藏在后台的shell id编号),执行exploit。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/msf_meter_exploit.png\" alt=\"msfconsole shell_to_meterpreter exploit \"></p>\n<p>成功后通过<code>session</code>命令可以看到我们已经获得了meterpreter会话。</p>\n<p>为了将权限提升到<b>NT AUTHORITY</b>，我们需要劫持靶机上一个<b>NT AUTHORITY\\SYSTEM</b>用户下的合法进程。进入meterpreter会话使用<code>ps</code>命令查看当前靶机上运行的进程都有哪些。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/meter_ps.png\" alt=\"meterpreter 执行 ps\"></p>\n<p>最终，我们选择劫持<a href=\"https://www.howtogeek.com/howto/28450/what-is-searchindexer.exe-and-why-is-it-running/\">SearchIndexer.exe进程</a>，使用<code>migrate</code>命令将meterpreter会话迁移到<code>SearchIndexer.exe</code>进程中，成功后，使用<code>getuid</code>查看当前用户。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/meter_getuid.png\" alt=\"meterpreter geuid\"></p>\n<p>劫持<code>SearchIndexer.exe</code>进程使我们能够以<b>NT AUTHORITY\\SYSTEM</b>执行代码，使用<code>hashdump</code>(post&#x2F;windwos&#x2F;gather&#x2F;hashdump)命令获取Windows用户账号的密码哈希值，该命令会转储安全账号管理器(SAM)数据库的内容。SAM数据库文件存储了Windows操作系统(包括Windwos 10)上的散列用户密码。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/meter_hashdump.png\" alt=\"meterpreter hashdump\"></p>\n<h1 id=\"破解密码哈希\"><a href=\"#破解密码哈希\" class=\"headerlink\" title=\"破解密码哈希\"></a>破解密码哈希</h1><p>转储的Windows用户凭证使用<a href=\"https://www.crowdstrike.com/cybersecurity-101/ntlm-windows-new-technology-lan-manager/\">NTLM</a>进行哈希处理。转储凭据可以分为4个部分：用户、相对标识符(RID)、LM哈希和NT哈希。例如，用户Jon的凭据可以拆分为：</p>\n<ul>\n<li>用户名:Jon</li>\n<li>RID: 1000</li>\n<li>LM Hash: aad3b435b51404eeaad3b435b51404ee</li>\n<li>NT Hash: ffb43f0de35be4d9917ac0cc8ad57f8d</li>\n</ul>\n<p>为了破解密码，将凭据中的NT Hash复制到文件中，使用<a href=\"https://hashcat.net/hashcat/\">HashCat</a>对NT哈希执行wordlist攻击。攻击词表使用kali中自带的<a href=\"https://www.kaggle.com/wjburns/common-password-list-rockyoutxt\">rockyou.txt</a>。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">hashcat -m 1000 -a 0 .&#x2F;hashes.txt &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rock<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ul>\n<li><code>-a</code>: 指定要使用的破解模式，其值参考后面对参数。“-a 0”字典攻击，“-a 1” 组合攻击；“-a 3”掩码攻击</li>\n<li><code>-m</code>: 指定要破解的hash类型，如果不指定类型，则默认是MD5(NTLM类型为1000)</li>\n</ul>\n<p><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/hashcat_jon.png\" alt=\"hashcat 破解密码\"></p>\n<h1 id=\"寻找Flag\"><a href=\"#寻找Flag\" class=\"headerlink\" title=\"寻找Flag\"></a>寻找Flag</h1><p>使用<code>search</code>命令查找匹配<code>flag*.txt</code>的文件,使用<code>cat</code>命令查看文件，获取flag。<br><img src=\"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/CTF/tryhackme/blue/meter_search.png\" alt=\"meterpreter search\"></p>\n<h1 id=\"参考文档\"><a href=\"#参考文档\" class=\"headerlink\" title=\"参考文档\"></a>参考文档</h1><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><ul>\n<li><a href=\"https://www.cnblogs.com/wf751620780/p/10730013.html\">Windows系统的dll注入</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/178597367\">后渗透之meterpreter使用攻略</a></li>\n<li><a href=\"https://www.offensive-security.com/metasploit-unleashed/privilege-escalation/\">PRIVILEGE ESCALATION</a></li>\n<li><a href=\"https://offsecdeer.gitlab.io/post/htb-writeup-grandpa/\">HackTheBox Writeup: Grandpa</a></li>\n</ul></blockquote>\n","text":"Blue CTF专注于通过利用SMB漏洞、使用Meterpreter提升权限、破解NTLM哈希以及遍历目录找到3个Flag。 侦察开启TryHackMe上的靶机，使用ping命令检查主机是否启动并开始运行。 确认靶机已经启动后，使用Nmap执行TCP SYN(sS)端口扫描，并对...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"CTF","slug":"CTF","count":6,"path":"api/categories/CTF.json"}],"tags":[{"name":"tryhackme","slug":"tryhackme","count":6,"path":"api/tags/tryhackme.json"},{"name":"Windows Privilege Escalation","slug":"Windows-Privilege-Escalation","count":4,"path":"api/tags/Windows-Privilege-Escalation.json"},{"name":"eternalblue","slug":"eternalblue","count":1,"path":"api/tags/eternalblue.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BE%A6%E5%AF%9F\"><span class=\"toc-text\">侦察</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%8E%B7%E5%BE%97%E8%AE%BF%E9%97%AE%E6%9D%83\"><span class=\"toc-text\">获得访问权</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%9D%83%E9%99%90%E5%8D%87%E7%BA%A7\"><span class=\"toc-text\">权限升级</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%A0%B4%E8%A7%A3%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C\"><span class=\"toc-text\">破解密码哈希</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AF%BB%E6%89%BEFlag\"><span class=\"toc-text\">寻找Flag</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3\"><span class=\"toc-text\">参考文档</span></a></li></ol>","author":{"name":"剑三","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"御剑乘风来 除魔天地间","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Linux网络抓包","uid":"9f9fe3f3013b488c2450ed12f2446a41","slug":"Linux网络抓包","date":"2022-03-17T17:29:47.691Z","updated":"2022-04-15T07:15:14.844Z","comments":true,"path":"api/articles/Linux网络抓包.json","keywords":null,"cover":"https://andrewhawkeye.oss-cn-beijing.aliyuncs.com/Blog/linux/network/network.jpeg","text":"通过网络抓包功能捕获指定IP和端口的网络数据包、分析数据包内容，帮助定位网络故障和分析攻击行为，从而识别出网络通信的安全风险,常用的网络抓包工具有wireshark、tcpdump、ngrep等。 网络抓包环境网络不论传输什么样的数据，最终通过物理层传输的都是二进制，类似0101...","link":"","photos":[],"count_time":{"symbolsCount":"8.1k","symbolsTime":"7 mins."},"categories":[{"name":"Network","slug":"Network","count":1,"path":"api/categories/Network.json"}],"tags":[{"name":"network","slug":"network","count":1,"path":"api/tags/network.json"},{"name":"libpcap","slug":"libpcap","count":1,"path":"api/tags/libpcap.json"}],"author":{"name":"剑三","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"御剑乘风来 除魔天地间","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{}}